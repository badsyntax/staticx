#!/usr/bin/env node

/*
 * staticx
 * https://github.com/badsyntax/staticx
 *
 * Copyright (c) 2013 Richard Willis
 * Licensed under the MIT license.
 */

'use strict';

/**
 * Load dependencies.
 */
var staticx = require('../lib/staticx');
var program = require('commander');
var Globalize = require('globalize');
var colors = require('colors');
var path = require('path');
var prompt = require('prompt');
var fs = require('fs');
var _ = require('lodash');

/**
 * Add colors to a string.
 * @param  {integer}  code      The exit code.
 * @param  {boolean}  substr    Is this a substitution string? (eg: 'Example %s')
 * @param  {string}   message   The message string to colorize.
 * @param  {integer}  index     The current array index.
 * @return {string}             The colorized string.
 */
function colorize(code, substr, message, index) {
  return !substr || index === 0 ? message[[
    'info',
    'error'
  ][code]] : message;
}

/**
 * Show a colorized log message and exit the process.
 * @param  {integer}  code      The exit code.
 * @param  {string}   message   The log message.
 */
function exit(code, message) {

  var args = [].slice.call(arguments, 1)
    .map(colorize.bind(null, code, /\%[sd]/.test(arguments[1])));

  console.log.apply(console, args);
  process.exit(code);
}

/**
 * Our base command object.
 */
var Command = {
  /**
   * Start the command.
   * @param  {object} options Command options.
   */
  init:  function(options) {
    if (options.interactive) {
      this.getOptions(options, this.action.bind(this));
    } else {
      this.action(options);
    }
  },
};

/**
 * Add page command
 */
var AddPage = _.extend({}, Command, {
  action: function(options) {
    if (!options.interactive && !options.content) {
      process.stdin.resume();
      process.stdin.setEncoding('utf8');
      process.stdin.on('data', function(data) {
        options.content = data;
        this.run(options);
      }.bind(this));
    } else {
      this.run(options);
    }
  },
  run: function(options) {

    _.merge(options, {
      date: (!options.date || options.date === 'now') ? new Date() : Globalize.parseDate(options.date),
      destination: options.destination || process.cwd()
    });

    var start = new Date();

    staticx.addPage(options, function(err, page) {

      if (err) exit(1, err);

      var msg = [
        'Successfully created a new page at: %s',
        'Completed in %dms'.data
      ].join('\n');

      exit(0, msg, path.resolve(page.filePath), new Date() - start);
    });
  },
  getOptions: function(options, done) {
    prompt.message = 'Add page';
    prompt.start();
    prompt.get([{
      name: 'destination',
      description: 'Destination path',
      type: 'string',
      message: 'Path does not exist',
      conform: function(value) {
        return !value || fs.existsSync(value);
      }
    }, {
      name: 'parent',
      description: 'Parent page',
      type: 'string',
      required: false,
      message: 'Parent page does not exist',
      confirm: function(value) {
        /** TODO */
        return false;
      }
    }, {
      name: 'title',
      description: 'Page title',
      type: 'string',
      required: true
    }, {
      name: 'date',
      description: 'Page date',
      type: 'string',
      required: true,
      default: 'now',
      conform: function(value) {
        return (value === 'now' || (Globalize.parseDate(value) instanceof Date));
      }
    }, {
      name: 'tags',
      description: 'Page tags',
      type: 'string',
      required: false
    }, {
      name: 'content',
      description: 'Page content',
      type: 'string',
      required: false
    }], function (err, result) {
      if (err) exit(1, err);
      done(_.merge(options, result));
    });
  }
});

/**
 * Create command object.
 */
var Create = _.extend({}, Command, {
  /**
   * Run the create action.
   * @param  {object} options The options object.
   */
  action: function(options) {

    var start = new Date();

    staticx.create(options, function(err) {
      if (err) exit(1, err);

      var msg = [
        'Successfully created a new site at: %s',
        'Completed in %dms'.data
      ].join('\n');

      exit(0, msg, path.resolve(options.destination), new Date() - start);
    });
  },
  /**
   * Prompt the user for various options.
   * @param  {Function} done The callback function to run once all options have
   * been gathered.
   */
  getOptions: function(done) {
    prompt.message = 'Create';
    prompt.start();
    prompt.get([{
      name: 'destination',
      description: 'Destination path',
      type: 'string',
      required: true,
      message: 'Path does not exist',
      conform: function(value) {
        return fs.existsSync(value);
      }
    }, {
      name: 'posts',
      description: 'Number of posts',
      type: 'string',
      pattern: /^\w+$/,
      default: '0',
      required: true
    }, {
      name: 'clean',
      description: 'Clean the directory first? (y/n)',
      type: 'string',
      pattern: /^[yn]$/i,
      message: 'Please enter either \'y\' or \'n\'',
      default: 'n',
      required: true,
      before: function(value) {
        return value.toLowerCase() === 'y';
      }
    }], function (err, result) {
      if (err) exit(1, err);
      done(result);
    });
  }
});

/**
 * The CLI object. This object will set the CLI environment and set the
 * commands which can be run from the CLI.
 * @type {Object}
 */
var CLI = {
  init: function() {
    program.version(staticx.pkg.version);
    this.setColors();
    this.setCommands();
    program.parse(process.argv);
  },
  setColors: function() {
    colors.setTheme({
      error: 'red',
      info: 'green',
      data: 'grey'
    });
  },
  setCommands: function() {

    program
    .command('create')
    .description('create a new site')
    .option('--destination <destination>', 'destination path')
    .option('--posts <posts>', 'number of dummy blog posts to generate', parseInt)
    .option('--clean', 'clean the destination folder before creating')
    .option('-i, --interactive', 'use prompts to set the options')
    .action(Create.init.bind(Create));

    program
    .command('addpage')
    .description('add a new page')
    .option('--destination <destination>', 'destination path')
    .option('--title <title>', 'page title')
    .option('--parent <parent>', 'parent page')
    .option('--date <date>', 'page date')
    .option('--tags <tags>', 'page tags')
    .option('-i, --interactive', 'use prompts to set the options')
    .action(AddPage.init.bind(AddPage));
  }
};

CLI.init();
